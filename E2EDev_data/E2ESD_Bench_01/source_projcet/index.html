<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>拖放购物车</title>
<style>
    * { margin: 0; padding: 0; }
    li { list-style: none; }
    li { float: left; width: 200px; margin: 10px; }
    li img { width: 200px; }
    p { height: 30px; line-height: 30px; text-indent: 1em; font-weight: bold; border-bottom: 1px #333 dashed; }
    #div1 { width: 600px; border: 1px #000 solid; height: 300px; clear: both; }
    .box1 { float: left; width: 200px; }
    .box2 { float: left; width: 200px; font-size: 12px}
    .box3 { float: left; width: 200px; }
    #allMoney { float: right; }
</style>
<script>src="observe.js"</script>
<script>
window.onload = function () {
    var aLi = document.getElementsByTagName('li');
    var oDiv = document.getElementById('div1');

    var obj = {};
    var iNum = 0; // 总金额
    var allMoney = null;
    var currencySymbol = ''; // 记录货币符号

    for (var i = 0; i < aLi.length; i++) {
        aLi[i].ondragstart = function (ev) {
            var aP = this.getElementsByTagName('p');

            ev.dataTransfer.setData('title', aP[0].innerHTML);
            ev.dataTransfer.setData('money', aP[1].innerHTML);

            ev.dataTransfer.setDragImage(this, 0, 0);
        };
    }

    oDiv.ondragover = function (ev) {
        ev.preventDefault();
    };

    oDiv.ondrop = function (ev) {
        ev.preventDefault();

        var sTitle = ev.dataTransfer.getData('title');
        var sMoney = ev.dataTransfer.getData('money');

        // 提取金额数字部分，并记录货币符号
        var moneyValue = parseFloat(sMoney.replace(/[^0-9.]/g, '')); // 提取数字
        var currentSymbol = sMoney.replace(/[0-9.]/g, '').trim(); // 提取符号
        if (!currencySymbol) {
            currencySymbol = currentSymbol; // 初始化货币符号
        }

        if (!obj[sTitle]) {
            var oP = document.createElement('p');
            var oSpan = document.createElement('span');
            oSpan.className = 'box1';
            oSpan.innerHTML = 1;
            oP.appendChild(oSpan);

            var oSpan = document.createElement('span');
            oSpan.className = 'box2';
            oSpan.innerHTML = sTitle;
            oP.appendChild(oSpan);

            var oSpan = document.createElement('span');
            oSpan.className = 'box3';
            oSpan.innerHTML = sMoney;
            oP.appendChild(oSpan);

            oDiv.appendChild(oP);

            obj[sTitle] = 1;
        } else {
            var box1 = document.getElementsByClassName('box1');
            var box2 = document.getElementsByClassName('box2');

            for (var i = 0; i < box2.length; i++) {
                if (box2[i].innerHTML == sTitle) {
                    box1[i].innerHTML = parseInt(box1[i].innerHTML) + 1;
                }
            }
        }

        if (!allMoney) {
            allMoney = document.createElement('div');
            allMoney.id = 'allMoney';
        }

        // 累加金额
        iNum += moneyValue;

        allMoney.innerHTML = `${currencySymbol}${iNum.toFixed(2)}`; // 显示两位小数
        oDiv.appendChild(allMoney);
    };
};
</script>
</head>
<body>
<ul>
<li draggable="true" data-testid="product-item-1">
<img src="img/img1.jpg" data-testid="product-image-1"/>
<p style="font-size: 12px" data-testid="product-title-1">The Essence of JavaScript</p>
<p data-testid="product-price-1">$40</p>
</li>
<li draggable="true" data-testid="product-item-2">
<img src="img/img2.jpg" data-testid="product-image-2"/>
<p style="font-size: 12px" data-testid="product-title-2">JavaScript: The Definitive Guide</p>
<p data-testid="product-price-2">$120</p>
</li>
<li draggable="true" data-testid="product-item-3">
<img src="img/img3.jpg" data-testid="product-image-3"/>
<p style="font-size: 12px" data-testid="product-title-3">Mastering JavaScript</p>
<p data-testid="product-price-3">$35</p>
</li>
<li draggable="true" data-testid="product-item-4">
<img src="img/img4.jpg" data-testid="product-image-4"/>
<p style="font-size: 12px" data-testid="product-title-4">The Art of DOM Programming</p>
<p data-testid="product-price-4">$45</p>
</li>
</ul>
<div data-testid="drop-area" id="div1"></div>
</body>
</html>
